#include <WiFi.h>
#include <AsyncTCP.h>
#include <ESPAsyncWebSrv.h>

const char* ssid = "MAJU 2.4G";
const char* password = "luhanaevaluna";

// Pines de cada salida
const int pinLuz    = 25;   // Luz
const int pinToma1  = 26;   // Tomacorriente 1 (relé)
const int pinToma2  = 27;   // Tomacorriente 2 (relé)

// Variables para guardar estado (false=apagado, true=encendido)
bool estadoLuz = false;
bool estadoToma1 = false;
bool estadoToma2 = false;

AsyncWebServer server(80);

void setup() 
{
  // Configurar pines como salidas y apagar todo al inicio (HIGH = apagado para relé)
  pinMode(pinLuz, OUTPUT);   digitalWrite(pinLuz, HIGH);   // apagado
  pinMode(pinToma1, OUTPUT); digitalWrite(pinToma1, HIGH); // apagado
  pinMode(pinToma2, OUTPUT); digitalWrite(pinToma2, HIGH); // apagado

  Serial.begin(115200);
  WiFi.begin(ssid, password);
  Serial.print("Conectando");
  while (WiFi.status() != WL_CONNECTED) {Serial.print("."); delay(500);}
  Serial.println("\nConectado!");
  Serial.print("IP: ");Serial.println(WiFi.localIP());

  // Página principal
  server.on("/", HTTP_GET, [](AsyncWebServerRequest *request){
    String html = "<!DOCTYPE html><html><head><meta name='viewport' content='width=device-width, initial-scale=1'>";
    html += "<style>body{font-family:Arial;text-align:center;}button{padding:10px 20px;margin:10px;font-size:16px;border:none;border-radius:5px;} .on{background:#4CAF50;color:white;} .off{background:#f44336;color:white;}</style>";
    html += "<script>";
    html += "function toggle(dev){fetch('/toggle?dev='+dev).then(r=>r.text()).then(t=>{document.getElementById(dev).innerHTML=t;document.getElementById(dev).className=(t.includes('ON')?'on':'off');});}";
    html += "</script></head><body>";
    html += "<h1>Panel de Control</h1>";

    if (estadoLuz) {
      html += "<button id='luz' class='on' onclick=\"toggle('luz')\">Luz ON</button><br>";
    } else {
      html += "<button id='luz' class='off' onclick=\"toggle('luz')\">Luz OFF</button><br>";
    }

    if (estadoToma1) {
      html += "<button id='toma1' class='on' onclick=\"toggle('toma1')\">Tomacorriente 1 ON</button><br>";
    } else {
      html += "<button id='toma1' class='off' onclick=\"toggle('toma1')\">Tomacorriente 1 OFF</button><br>";
    }

    if (estadoToma2) {
      html += "<button id='toma2' class='on' onclick=\"toggle('toma2')\">Tomacorriente 2 ON</button><br>";
    } else {
      html += "<button id='toma2' class='off' onclick=\"toggle('toma2')\">Tomacorriente 2 OFF</button><br>";
    }

    html += "</body></html>";
    request->send(200, "text/html", html);
  });

  // Ruta única para cambiar estado
  server.on("/toggle", HTTP_GET, [](AsyncWebServerRequest *request){
    if (request->hasParam("dev")) {
      String dev = request->getParam("dev")->value();
      String respuesta;

      if (dev == "luz") {
        estadoLuz = !estadoLuz; // cambiar estado
        if (estadoLuz) {
          digitalWrite(pinLuz, LOW); // encender
          respuesta = "Luz ON";
        } else {
          digitalWrite(pinLuz, HIGH); // apagar
          respuesta = "Luz OFF";
        }
      } 
      else if (dev == "toma1") {
        estadoToma1 = !estadoToma1;
        if (estadoToma1) {
          digitalWrite(pinToma1, LOW);
          respuesta = "Tomacorriente 1 ON";
        } else {
          digitalWrite(pinToma1, HIGH);
          respuesta = "Tomacorriente 1 OFF";
        }
      } 
      else if (dev == "toma2") {
        estadoToma2 = !estadoToma2;
        if (estadoToma2) {
          digitalWrite(pinToma2, LOW);
          respuesta = "Tomacorriente 2 ON";
        } else {
          digitalWrite(pinToma2, HIGH);
          respuesta = "Tomacorriente 2 OFF";
        }
      } 
      else {
        respuesta = "Dispositivo desconocido";
      }

      request->send(200, "text/plain", respuesta);
    } else {
      request->send(400, "text/plain", "Parámetro dev faltante");
    }
  });

  server.begin();
}

void loop() {
  // Nada aquí
}
